# ドメインエンティティ設計書 - Unit1: タスク作成機能

## 作成情報

- **作成日**: 2025-10-22
- **設計対象**: タスク作成機能のドメインエンティティ
- **分析フェーズ**: フェーズ2-1（ドメインエンティティの識別）
- **参照元**: 要件分析書（requirements-analysis.md）

## 1. Taskエンティティ

### 1.1 エンティティ概要

**エンティティ名**: Task
**責務**: ユーザーが管理するタスクの基本情報と状態を保持する
**識別子**: taskId（一意識別子）
**集約ルート**: Task（このエンティティが集約の境界）

### 1.2 属性定義

| 属性名 | 型 | 必須 | デフォルト値 | 説明 | ビジネスルール |
|--------|-----|------|-------------|------|---------------|
| taskId | TaskId（値オブジェクト） | Yes | 自動生成 | タスクの一意識別子 | UUID形式で生成される |
| taskName | TaskName（値オブジェクト） | Yes | - | タスクの名称 | BR-001: 必須項目、BR-004: 100文字以内 |
| status | TaskStatus（値オブジェクト） | Yes | "未完了" | タスクの状態 | 初期値は「未完了」 |
| createdAt | CreatedAt（値オブジェクト） | Yes | 現在日時 | 作成日時 | 作成時に自動設定 |
| updatedAt | UpdatedAt（値オブジェクト） | Yes | 現在日時 | 更新日時 | 作成・更新時に自動設定 |

### 1.3 値オブジェクト詳細

#### 1.3.1 TaskId（値オブジェクト）
```
属性:
- value: string（UUID形式）

制約:
- null不可
- 空文字不可
- UUID形式であること

振る舞い:
- 等価性比較
- 文字列表現への変換
```

#### 1.3.2 TaskName（値オブジェクト）
```
属性:
- value: string

制約:
- null不可（BR-001）
- 空文字不可（BR-001）
- 100文字以内（BR-004）
- 特殊文字のエスケープ処理（BR-005）

振る舞い:
- 等価性比較
- 文字数バリデーション
- 特殊文字サニタイゼーション
- トリミング処理
```

#### 1.3.3 TaskStatus（値オブジェクト）
```
属性:
- value: string

制約:
- 事前定義された値のみ許可（"未完了", "完了", "保留"等）
- null不可

振る舞い:
- 等価性比較
- 状態遷移の妥当性チェック
```

#### 1.3.4 CreatedAt / UpdatedAt（値オブジェクト）
```
属性:
- value: DateTime

制約:
- null不可
- 過去または現在の日時であること

振る舞い:
- 等価性比較
- フォーマット変換
```

### 1.4 エンティティの振る舞い

#### 1.4.1 作成時の振る舞い
```
操作: create(taskName: string)
目的: 新しいTaskエンティティを作成する

処理フロー:
1. TaskNameの作成とバリデーション（BR-001, BR-004, BR-005）
2. TaskIdの自動生成
3. TaskStatusのデフォルト値設定（"未完了"）
4. CreatedAt、UpdatedAtの現在日時設定
5. 不変条件の検証
6. Taskエンティティの生成

事前条件:
- taskNameが指定されている

事後条件:
- 有効なTaskエンティティが作成される
- すべての必須属性が設定される
- ビジネスルールが満たされる

例外:
- TaskNameValidationException: タスク名が無効な場合
- TaskCreationException: 作成処理に失敗した場合
```

#### 1.4.2 更新時の振る舞い
```
操作: updateTaskName(newTaskName: string)
目的: タスク名を更新する

処理フロー:
1. 新しいTaskNameの作成とバリデーション
2. UpdatedAtの更新
3. 不変条件の検証

事前条件:
- Taskエンティティが存在する
- newTaskNameが有効である

事後条件:
- taskNameが更新される
- updatedAtが更新される
```

### 1.5 エンティティライフサイクル

#### 1.5.1 状態遷移図（マークダウン形式）
```
[作成要求] → [バリデーション] → [エンティティ生成]
                    ↓
              [バリデーション失敗] → [例外発生]

[既存エンティティ] → [更新要求] → [バリデーション] → [エンティティ更新]
                                        ↓
                                [バリデーション失敗] → [例外発生]
```

#### 1.5.2 ライフサイクルフェーズ

1. **生成フェーズ**
   - TaskName のバリデーション
   - 必須属性の設定
   - 不変条件の確立

2. **運用フェーズ**
   - 属性の更新
   - 状態遷移
   - 不変条件の維持

3. **終了フェーズ**
   - エンティティの削除（現在のユニットでは対象外）

### 1.6 不変条件（インバリアント）

#### 1.6.1 エンティティレベルの不変条件
```
INV-001: taskId は null でなく、かつ一意である
INV-002: taskName は null でなく、空文字でなく、100文字以内である
INV-003: status は定義済みの値のいずれかである
INV-004: createdAt は updatedAt より前または同じ日時である
INV-005: すべての属性がnullでない
```

#### 1.6.2 ビジネス不変条件
```
BIV-001: 作成されたTaskは必ず初期状態「未完了」を持つ
BIV-002: TaskNameには特殊文字が適切にエスケープされて保存される
BIV-003: 同一のtaskIdを持つTaskは同一のエンティティである
```

### 1.7 エンティティの等価性

#### 1.7.1 同一性判定
```
判定基準: taskId による比較
実装: equals(other: Task) → boolean

同一性の条件:
- 両方のエンティティのtaskIdが等しい
- taskIdがnullでない
```

#### 1.7.2 ハッシュ値
```
ハッシュ基準: taskId のハッシュ値
実装: hashCode() → number
```

## 2. 集約設計

### 2.1 Task集約

**集約ルート**: Task
**境界**: Task エンティティのみ（現在のユニットでは単一エンティティ）

#### 2.1.1 集約の責務
- タスク作成時の整合性保証
- ビジネスルールの実施
- 不変条件の維持

#### 2.1.2 集約境界の理由
- Task は独立して管理される単位
- 他のエンティティとの複雑な関連はない（現在のスコープ）
- トランザクション境界として適切

## 3. ドメインイベント

### 3.1 TaskCreatedEvent

```
イベント名: TaskCreatedEvent
発生タイミング: Taskエンティティの作成完了時

属性:
- taskId: TaskId
- taskName: string
- createdAt: DateTime
- occurredAt: DateTime

目的:
- 他の境界コンテキストへの通知
- 監査ログの記録
- 統計情報の更新（将来的な拡張）
```

## 4. エンティティファクトリ

### 4.1 TaskFactory

```
目的: 複雑なTask生成ロジックの集約
責務:
- バリデーション付きTask作成
- デフォルト値の適用
- ドメインイベントの生成

操作:
- createTask(taskName: string): Task
- createTaskWithEvent(taskName: string): (Task, TaskCreatedEvent)

利点:
- 作成ロジックの集約
- テスト容易性の向上
- 複雑な初期化処理の隠蔽
```

## 5. 実装時の考慮事項

### 5.1 バリデーション戦略
- エンティティ作成時に即時バリデーション実行
- 値オブジェクトレベルでの制約チェック
- エンティティレベルでの不変条件チェック

### 5.2 例外処理戦略
- ドメイン固有例外の定義
- バリデーション失敗時の詳細メッセージ
- 例外の階層化（TaskException < DomainException）

### 5.3 テスト戦略
- 各値オブジェクトの独立テスト
- エンティティ作成パターンのテスト
- 不変条件違反のテスト
- 境界値テスト

## 6. 他ユニットとの関連

### 6.1 データ出力仕様（TaskDataInterface準拠）
```
出力データ形式:
- taskId: string（UUID）
- taskName: string
- createdAt: datetime（ISO8601形式）
- status: string（初期値：「未完了」）

変換処理:
- 値オブジェクトから基本型への変換
- 日時フォーマットの統一
- 外部システム用の文字エンコーディング
```

### 6.2 拡張性の考慮
- 将来的な属性追加に対する柔軟性
- 他ユニットとの結合度最小化
- インターフェース変更時の影響範囲限定

---

**次フェーズへの引き継ぎ**:
- Taskエンティティの設計完了
- 6つの不変条件とビジネスルールの実装準備完了
- ドメインイベント発行の仕組み設計完了